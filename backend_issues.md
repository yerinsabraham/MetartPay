Backend issues observed (collected during local runs on Oct 8, 2025)

Summary
- The Payment Links Cloud Function is returning HTTP 500 with body: {"error":"Failed to fetch payment links","details":"9 FAILED_PRECONDITION: The query requires an index. You can create it here: <URL>"}
- Firestore queries from the app are failing with FAILED_PRECONDITION (index required) and PERMISSION_DENIED (missing or insufficient permissions).
- Create Payment Link endpoint returned 400 with {"error":"Merchant wallets not generated yet"} in some flows.

Exact log excerpts
- Get payment links response: 500
  Body: {"error":"Failed to fetch payment links","details":"9 FAILED_PRECONDITION: The query requires an index. You can create it here: https://console.firebase.google.com/v1/r/project/metartpay-bac2f/firestore/indexes?create_composite=ClRwcm9qZWN0cy9tZXRhcnRwYXktYmFjMmYvZGF0YWJhc2VzLyhkZWZhdWx0KS9jb2xsZWN0aW9uR3JvdXBzL3BheW1lbnRMaW5rcy9pbmRleGVzL18QARoOCgptZXJjaGFudElkEAEaDQoJY3JlYXRlZEF0EAIaDAoIX19uYW1lX18QAg"}

- Firestore: Listen for Query(payment_links where merchantId==<id> order by -createdAt, -__name__); failed: Status{code=PERMISSION_DENIED, description=Missing or insufficient permissions.}

- Create payment link response: 400
  Body: {"error":"Merchant wallets not generated yet"}

Recommended backend tasks (priority order)
1. Cloud Functions: open logs for the payment-links function and inspect stack traces. Fix any unhandled exceptions that cause 500s. The function appears to be rejecting the Firestore query due to missing composite index.
2. Firestore indexes: follow the "create_composite" link printed in the logs and create the suggested composite index(es). They typically correspond to queries with multiple orderBy/where clauses (e.g., where merchantId == X orderBy createdAt desc).
3. Firestore rules/permissions: review the service account / Cloud Function runtime identity and any client SDK rules. Ensure the rules allow the needed reads for authenticated function/service accounts. For client-side queries (if used), ensure security rules permit the app's flow or use Callable Functions with elevated privileges.
4. Create Payment Link flow: investigate why merchant wallets are missing. Either ensure wallets are generated during merchant onboarding, or surface a user-friendly guidance path (e.g., generate wallets automatically during link creation or return a clear actionable error explaining how to generate wallets).
5. Add tests and monitoring: add unit tests for the Cloud Function query paths and enable structured logging to capture stack traces and request IDs.

Helpful info to include when debugging
- Exact request trace / trace ID from the Cloud Function logs
- Timestamped log lines from the function during failing requests
- The composite index URL(s) printed in logs (open them and create indexes)
- The Cloud Function environment (Node version, dependencies) and recent deployments

If you'd like, I can:
- Draft a small PR-ready fix for the Cloud Function query (if you share the function code path), or
- Create the Firestore index programmatically (I can provide the JSON index definitions you can paste into the Firebase Console or deploy via gcloud), or
- Continue making client-side UX improvements (tests, per-item stale badgesâ€”which I have already added).

---
Generated by local app run on Oct 8, 2025. If you want me to prepare artifacts for your backend team (detailed trace snippets, gcloud commands to create indexes, or a PR patch), I can proceed automatically.